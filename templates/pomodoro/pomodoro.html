{% extends 'layout/base.html' %}

{% block title %}Pomodoro | FocusNote{% endblock %}

{% block extra_css %}
<style>
    .pomodoro-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .timer-display {
        font-size: 4rem;
        font-weight: bold;
        color: #dc3545;
        text-align: center;
        font-family: 'Courier New', monospace;
        white-space: nowrap;
        z-index: 10;
    }
    
    .timer-display.break {
        color: #28a745;
    }
    
    .status-text {
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: 2rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }
    
    .btn-pomodoro {
        min-width: 120px;
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-pomodoro:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transition: all 0.2s;
    }
    
    .progress-ring {
        margin: 2rem auto;
        width: 300px;
        height: 300px;
        position: relative;
    }
    
    .progress-ring svg {
        display: block;
    }
    
    .progress-ring circle {
        transition: stroke-dashoffset 0.35s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    
    @media (max-width: 768px) {
        .timer-display {
            font-size: 2.5rem;
        }
        
        .progress-ring {
            width: 250px;
            height: 250px;
        }
        
        .progress-ring svg {
            width: 250px;
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pomodoro-container">
    <div class="text-center mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{% url 'home' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver al Dashboard
            </a>
            <span></span>
        </div>
        <h1 class="display-4"><i class="bi bi-hourglass-split"></i> Pomodoro</h1>
        <p class="lead text-muted">T√©cnica de productividad: 25 minutos de trabajo, 5 minutos de descanso</p>
    </div>

    <!-- Estado actual -->
    <div class="status-text" id="status">
        Listo para comenzar
    </div>

    <!-- C√≠rculo de progreso SVG con temporizador centrado -->
    <div class="progress-ring position-relative">
        <svg width="300" height="300" viewBox="0 0 300 300" class="d-block mx-auto">
            <circle
                cx="150"
                cy="150"
                r="140"
                fill="none"
                stroke="#e9ecef"
                stroke-width="10"
            />
            <circle
                id="progress-circle"
                cx="150"
                cy="150"
                r="140"
                fill="none"
                stroke="#dc3545"
                stroke-width="10"
                stroke-dasharray="879.65"
                stroke-dashoffset="879.65"
                stroke-linecap="round"
            />
        </svg>
        <!-- Display del temporizador centrado sobre el c√≠rculo -->
        <div class="timer-display position-absolute top-50 start-50 translate-middle" id="timer" style="margin: 0;">
            25:00
        </div>
    </div>

    <!-- Botones de control -->
    <div class="controls">
        <button type="button" class="btn btn-success btn-pomodoro" id="startBtn">
            <i class="bi bi-play-fill"></i> Iniciar
        </button>
        <button type="button" class="btn btn-warning btn-pomodoro" id="pauseBtn" disabled>
            <i class="bi bi-pause-fill"></i> Pausar
        </button>
        <button type="button" class="btn btn-secondary btn-pomodoro" id="resetBtn">
            <i class="bi bi-arrow-clockwise"></i> Reiniciar
        </button>
    </div>

    <!-- Informaci√≥n adicional -->
    <div class="card mt-5">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-info-circle"></i> Informaci√≥n</h5>
            <p class="card-text">
                <strong>Ciclo actual:</strong> <span id="cycle-count">0</span> completado(s)<br>
                <strong>Tiempo total:</strong> <span id="total-time">0</span> minutos
            </p>
        </div>
    </div>
</div>

<script>
    // Configuraci√≥n del Pomodoro
    const WORK_DURATION = 25 * 60; // 25 minutos en segundos
    const BREAK_DURATION = 5 * 60;  // 5 minutos en segundos
    const CIRCUMFERENCE = 2 * Math.PI * 140; // Circunferencia del c√≠rculo

    // Estado del temporizador
    let timeLeft = WORK_DURATION;
    let isRunning = false;
    let isBreak = false;
    let intervalId = null;
    let cyclesCompleted = 0;
    let totalMinutes = 0;
    let startTime = null;

    // Elementos del DOM
    const timerDisplay = document.getElementById('timer');
    const statusText = document.getElementById('status');
    const progressCircle = document.getElementById('progress-circle');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const cycleCount = document.getElementById('cycle-count');
    const totalTimeDisplay = document.getElementById('total-time');

    // Funci√≥n para formatear el tiempo (MM:SS)
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Funci√≥n para actualizar el display
    function updateDisplay() {
        timerDisplay.textContent = formatTime(timeLeft);
        
        // Actualizar el c√≠rculo de progreso
        const totalDuration = isBreak ? BREAK_DURATION : WORK_DURATION;
        const progress = (totalDuration - timeLeft) / totalDuration;
        const offset = CIRCUMFERENCE * (1 - progress);
        progressCircle.style.strokeDashoffset = offset;
        
        // Cambiar color seg√∫n el modo
        if (isBreak) {
            timerDisplay.classList.add('break');
            progressCircle.style.stroke = '#28a745';
        } else {
            timerDisplay.classList.remove('break');
            progressCircle.style.stroke = '#dc3545';
        }
    }

    // Funci√≥n para actualizar el estado
    function updateStatus() {
        if (isRunning) {
            statusText.textContent = isBreak ? '‚è∏ Descanso' : 'üî• Trabajando';
        } else {
            statusText.textContent = isBreak ? 'Descanso pausado' : 'Trabajo pausado';
        }
    }

    // Funci√≥n del temporizador
    function tick() {
        if (timeLeft > 0) {
            timeLeft--;
            updateDisplay();
            
            // Actualizar tiempo total
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                totalMinutes = Math.floor(elapsed / 60);
                totalTimeDisplay.textContent = totalMinutes;
            }
        } else {
            // Tiempo terminado
            clearInterval(intervalId);
            isRunning = false;
            
            // Sonido de notificaci√≥n (usando Web Audio API)
            playNotificationSound();
            
            if (isBreak) {
                // Fin del descanso, comenzar trabajo
                isBreak = false;
                timeLeft = WORK_DURATION;
                statusText.textContent = 'Descanso completado. ¬°A trabajar!';
            } else {
                // Fin del trabajo, comenzar descanso
                isBreak = true;
                timeLeft = BREAK_DURATION;
                cyclesCompleted++;
                cycleCount.textContent = cyclesCompleted;
                statusText.textContent = 'üéâ Pomodoro completado. ¬°T√≥mate un descanso!';
            }
            
            updateDisplay();
            updateStatus();
            updateButtons();
            
            // Auto-iniciar el siguiente ciclo despu√©s de 2 segundos
            setTimeout(() => {
                if (confirm(isBreak ? 
                    '¬øIniciar el descanso ahora?' : 
                    '¬øIniciar el siguiente Pomodoro?')) {
                    startTimer();
                }
            }, 2000);
        }
    }

    // Funci√≥n para reproducir sonido de notificaci√≥n
    function playNotificationSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }

    // Funci√≥n para iniciar el temporizador
    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            if (!startTime) {
                startTime = Date.now();
            }
            intervalId = setInterval(tick, 1000);
            updateStatus();
            updateButtons();
        }
    }

    // Funci√≥n para pausar el temporizador
    function pauseTimer() {
        if (isRunning) {
            isRunning = false;
            clearInterval(intervalId);
            updateStatus();
            updateButtons();
        }
    }

    // Funci√≥n para reiniciar el temporizador
    function resetTimer() {
        isRunning = false;
        clearInterval(intervalId);
        isBreak = false;
        timeLeft = WORK_DURATION;
        startTime = null;
        updateDisplay();
        updateStatus();
        updateButtons();
        statusText.textContent = 'Listo para comenzar';
    }

    // Funci√≥n para actualizar el estado de los botones
    function updateButtons() {
        startBtn.disabled = isRunning;
        pauseBtn.disabled = !isRunning;
    }

    // Event listeners
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    // Inicializar display
    updateDisplay();
    updateStatus();
</script>
{% endblock %}

