{% extends 'layout/base.html' %}

{% block title %}
    {% if modo == 'editar' %}Editar Nota | FocusNote{% else %}Nueva Nota | FocusNote{% endif %}
{% endblock %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    .notes-editor-wrapper {
        max-width: 960px;
        margin: 0 auto;
    }
    .notes-editor-header {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .notes-editor-title {
        font-size: 1.8rem;
        font-weight: 600;
        border: none;
        outline: none;
        padding: 0;
        background: transparent;
        width: 100%;
    }
    .notes-editor-title::placeholder {
        color: var(--text-muted);
    }
    .notes-editor-card {
        border-radius: 18px;
        border: 1px solid var(--border-soft);
        background: var(--card-bg);
        padding: 1.5rem 1.4rem 1.3rem;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
    }
    .notes-editor-toolbar {
        border-radius: 12px 12px 0 0;
        border-color: var(--border-soft);
        background: rgba(15, 23, 42, 0.02);
    }
    .notes-editor-container {
        border-radius: 0 0 12px 12px;
        border-color: var(--border-soft);
        min-height: 320px;
        background: var(--bg-secondary);
    }
    .ql-editor {
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="notes-editor-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <small class="text-muted d-block">{% if modo == 'editar' %}Editar nota{% else %}Nueva nota{% endif %}</small>
            <h1 class="h4 mb-0">Notas</h1>
        </div>
        <a href="{% url 'notas:listar' %}" class="btn btn-outline-secondary btn-sm">Volver a mis notas</a>
    </div>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="notes-editor-card">
        <form method="POST" id="nota-form">
            {% csrf_token %}

            <div class="notes-editor-header">
                <input
                    type="text"
                    id="titulo"
                    name="titulo"
                    class="notes-editor-title"
                    maxlength="255"
                    placeholder="Título de la nota"
                    value="{% if nota %}{{ nota.titulo }}{% endif %}"
                    required
                    autofocus
                >

                <div class="d-flex flex-wrap align-items-center gap-2">
                    <label for="materia" class="form-label mb-0 small text-muted">Materia</label>
                    <select class="form-select form-select-sm w-auto" id="materia" name="materia">
                        <option value="">Sin materia</option>
                        {% for materia in materias %}
                            <option value="{{ materia.pk }}" {% if nota and nota.materia and nota.materia.pk == materia.pk %}selected{% endif %}>
                                {{ materia.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Editor Quill -->
            <div id="toolbar" class="notes-editor-toolbar mb-0">
                <span class="ql-formats">
                    <select class="ql-header">
                        <option selected></option>
                        <option value="1"></option>
                        <option value="2"></option>
                        <option value="3"></option>
                    </select>
                </span>
                <span class="ql-formats">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                </span>
                <span class="ql-formats">
                    <button class="ql-list" value="ordered"></button>
                    <button class="ql-list" value="bullet"></button>
                </span>
            </div>
            <div id="editor" class="notes-editor-container"></div>

            <!-- Campo oculto para enviar el HTML -->
            <input type="hidden" name="contenido" id="contenido">

            <div class="d-flex justify-content-between align-items-center mt-3">
                {% if nota %}
                <small class="text-muted">
                    Creada: {{ nota.fecha_creacion|date:"d/m/Y H:i" }} · Última actualización: {{ nota.fecha_actualizacion|date:"d/m/Y H:i" }}
                </small>
                {% else %}
                <span></span>
                {% endif %}
                <div class="d-flex gap-2">
                    <a href="{% url 'notas:listar' %}" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">
                        {% if modo == 'editar' %}Guardar cambios{% else %}Guardar nota{% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
    (function() {
        const editorElement = document.getElementById('editor');
        if (!editorElement) return;

        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: '#toolbar'
            }
        });

        // Inicializar contenido si estamos editando
        {% if nota and nota.contenido %}
            quill.root.innerHTML = {{ nota.contenido|safe|escapejs }};
        {% endif %}

        const form = document.getElementById('nota-form');
        const hiddenInput = document.getElementById('contenido');

        form.addEventListener('submit', function () {
            hiddenInput.value = quill.root.innerHTML;
        });
    })();
</script>
{% endblock %}
